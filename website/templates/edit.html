{% extends "_base.html" %}

{% block head %}
<script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}/js/tool.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=places"></script>
<link rel="stylesheet" type="text/css" href="{{ static_url }}/css/tool.css">
{% endblock %}

{% block content %}

<section id="editor" class="container shrinktext"> 

<div class="row">
    <div class="span12">
        <a href="select.html">&lt;&lt; back</a>
    </div>
</div>

<div class="row slides-row">
    <div class="slides-container">
        <div id="slides">      
        </div>
    </div>
</div>

<div class="row map-row">
    <div id="map"></div>
    <input id="map_search_input" type="text" placeholder="Search Box">
</div>

<div class="row data-row">
    <div class="span12">
        <div class="row">   
             
            <div class="span6">
                <label>URL</label>
                <input id="url" type="text" />
                 <label>Credit</label>
                <input id="credit" type="text" />
                 <label>Caption</label>
                <input id="caption" type="text" />
            </div>
        
            <div class="span6">                     
                <label>Date</label>
                <input id="date" type="text" placeholder="TODO: put examples here" />
                
                <label>Headline</label>
                <textarea id="headline" rows="3"></textarea>

                <label>Text</label>
                <textarea id="text" rows="6"></textarea>  
            </div>
            
        </div>
    </div>
</div>

<div class="row control-row">
    <button id="storymap_save" class="btn">Save</button>
    <button id="storymap_publish" class="btn">Publish</button>
    <button id="slide_add" class="btn">Add Slide</button>
</div>
</section>

<!-- START MODALS -->
<div id="error_modal" class="modal hide fade" role="dialog" aria-hidden="true">
    <div class="modal-body">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <p><span id="error_msg">Boo</span></p>
   </div>
</div>

<div id="progress_modal" class="modal hide fade" role="dialog" aria-hidden="true">
    <div class="modal-body">
        <p><i class="icon-spinner icon-spin"></i><span id="progress_msg"></span>...</p>
    </div>
</div>

<div id="confirm_modal" class="modal hide fade" role="dialog" aria-hidden="true">
    <div class="modal-body">
        <p id="confirm_msg"></p>
    </div>
    <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
        <button class="btn btn-primary">Delete</button>
    </div>
</div>
<!-- END MODALS -->
  
<script type="text/javascript">

var _map;
var _marker;
 
var _storymap;
var _current_slide_index = -1;

var _dirty = 0;
   
/*
var storymap = new VCO.StoryMap('storymap', '{{ static_url }}/demo/demo.json');
window.onresize = function(event) {
    storymap.updateDisplay();
}
*/

function location_set(loc_data) {
    $.extend(_storymap.slides[_current_slide_index].location, loc_data);      
    storymap_dirty(1);
}

function location_drag() {
    var pos = _marker.getPosition();
    location_set({lat: pos.lat(), lon: pos.lng()});
}

function location_mark(loc_data) {
    // Clear old marker
    if(_marker) {
        _marker.setMap(null);
    }    
    
    // Set new marker
    if(loc_data) {
        var latlng = new google.maps.LatLng(loc_data.lat, loc_data.lon);
    
        _marker = new google.maps.Marker({
            map: _map,
            draggable: true,
            title: loc_data.name,
            position: latlng
        });
   
        _map.panTo(latlng);
     
        google.maps.event.addListener(_marker, 'dragend', location_drag);
    }
}

function slide_append_element() {
    var i = $('div.slide').length;
    
    var elem = $('<div class="slide"><span>'+(i+1)+'</span></div>')
        .appendTo('#slides')
        .click(slide_select);
            
    $('<a class="close" href="#">&times;</a>')
        .appendTo(elem)
        .click(slide_delete); 
    
    return elem;
}

function slide_select(event) {   
    $('div.slide.selected').removeClass('selected');    
    $(this).addClass('selected');     

    _current_slide_index = $(this).index();   
     
    var data = _storymap.slides[_current_slide_index];

    location_mark(data.location);         
    
    $('#url').val(data.media.url);
    $('#credit').val(data.media.credit);
    $('#caption').val(data.media.caption);
    
    $('#date').val(data.date || '');
    $('#headline').val(data.text.headline || '');
    $('#text').val(data.text.text || '');    
}

function slide_delete(event) {
    var slide_elem = $(this).closest('div.slide');
    var slide_index = slide_elem.index();
    
    show_confirm('Delete slide '+(slide_index+1)+'?', function() {
        var width = $('#slides').width() - slide_elem.outerWidth(true);
        
        // Renumber slides after slide to delete
        var i = slide_index + 1;
        slide_elem.nextAll().each(function() { $(this).find('span').html(i++); });
  
        // Delete the slide
        _storymap.slides.splice(slide_index, 1); 
        slide_elem.remove();
        
        // Adjust slide container width
        $('#slides').css('width', width+"px");       
                             
        // Reset current slide
        if(slide_index < _current_slide_index) {
            _current_slide_index--;
        } else if(slide_index == _current_slide_index) {
            var n = Math.min(_current_slide_index, _storymap.slides.length - 1);
            
            if(n < 0) {                
                slide_add();
            } else {
                $('div.slide:eq('+n+')').click();
            }
        } 
        
        storymap_dirty(1);        
    });
    
    return false;
}

function slide_add() {
    // Push new slide
    _storymap.slides.push({
        date: "",
        text: {
            headline: "",
            text: ""
        },
        location: {
            name: "Chicago, IL",
            lat: "41.850033",
            lon: "-87.6500523",
            zoom: 10,
            line: true,
            icon: "http://maps.gstatic.com/intl/en_us/mapfiles/ms/micons/blue-pushpin.png"
        },
        media: {
            url: "",
            credit: "",
            caption: ""
        }
    });
    
    // Append slide element
    var slide = slide_append_element();
            
    // Adjust slide container width
    var width = $('#slides').width() + slide.outerWidth(true);
    $('#slides').css('width', width+"px");
    
    // Scroll new slide into view
    $('.slides-container').scrollLeft(Math.max(0, width - $('#slides').parent().width()));

    // Select new slide
    slide.click();
    
    storymap_dirty(1);
}

function storymap_load(id) {
    do_ajax(id, {},
        function(error) {
            alert(error);
        },
        function(data) {
            _storymap = data.storymap;
            
            $('#slides').html();            
            for(var i = 0; i < _storymap.slides.length; i++) {
                slide_append_element();
            }
            
            var width = 0;
            $('#slides div.slide').each(function() {
                width += $(this).outerWidth(true);
            })   
            $('#slides').css('width', width + "px");
        
            if(_storymap.slides.length) { 
                $('div.slide:first').click();           
            } else {
                slide_add();
            }
        }
    );   
}

function storymap_dirty(is_dirty) {
    _dirty = is_dirty;
    
    if(is_dirty) {
        $('#storymap_save').addClass('btn-primary');
    } else {
        $('#storymap_save').removeClass('btn-primary');
    }
}

function storymap_save() {
    alert('TODO');
    storymap_dirty(0);
}

function storymap_publish() {
    alert('TODO');
    storymap_dirty(0);
}

function initialize() {
    // check for id parameter
    var params = parseQuerystring();
    
    if(!params.id) {
        alert('you would need to pass an id as a query parameter');
        return;
    }
    
    // make map
    var mapOptions = {
        mapTypeControl: false,
        panControl: true,
        zoomControl: true,
        zoomControlOptions: {
            style: google.maps.ZoomControlStyle.SMALL
        },
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };   
    _map = new google.maps.Map(document.getElementById('map'), mapOptions);
    
    // center over Chicago
    var defaultBounds = new google.maps.LatLngBounds(
        new google.maps.LatLng(41.644, -87.96),
        new google.maps.LatLng(42.04, -87.40)
    );
    _map.fitBounds(defaultBounds);

    // make search box
    map_search_box = new google.maps.places.SearchBox(
        document.getElementById('map_search_input'));
        
    // handle search
    google.maps.event.addListener(map_search_box, 'places_changed', function() {
        var places = map_search_box.getPlaces();
        
        if(places.length) {
            var place = places[0];
            
            var loc_data = {
                name: place.name,
                lat: place.geometry.location.lat(),
                lon: place.geometry.location.lng()
            };
            
            location_mark(loc_data);
            location_set(loc_data);
         } 
    });
    
    // load storymap
    storymap_load(params.id);
}

google.maps.event.addDomListener(window, 'load', initialize);

$(function() {    
    $('#url, #credit, #caption, #date, #headline, #text').change(function() {
        storymap_dirty(1);
    });
    
    $('#slide_add').click(slide_add);
    $('#storymap_save').click(storymap_save);
    $('#storymap_publish').click(storymap_publish);
});

</script>


{% endblock %}